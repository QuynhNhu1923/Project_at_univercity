<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIMS - Internet Media Store</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .search-bar {
            display: flex;
            gap: 10px;
        }
        .search-bar input, .search-bar select, .search-bar button {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .product-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }
        .product-card {
            background: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
        }
        .product-card img {
            max-width: 100%;
            height: auto;
            border-radius: 5px;
        }
        .product-card h3 {
            font-size: 1.2em;
            margin: 10px 0;
        }
        .product-card p {
            color: #555;
            margin: 5px 0;
        }
        .product-card button {
            background-color: #28a745;
            color: white;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .product-card button:hover {
            background-color: #218838;
        }
        #cart, #order, #manager, #orders, #login {
            margin-top: 20px;
            background: white;
            padding: 15px;
            border-radius: 5px;
        }
        #cart ul, #order ul, #orders ul {
            list-style: none;
            padding: 0;
        }
        #cart li, #order li, #orders li {
            margin: 10px 0;
        }
        #manager form, #login form {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 400px;
        }
        #manager input, #manager select, #login input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .order-card {
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>AIMS - Internet Media Store</h1>
        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="Search products...">
            <select id="sortSelect">
                <option value="price-asc">Price: Low to High</option>
                <option value="price-desc">Price: High to Low</option>
            </select>
            <button onclick="searchProducts()">Search</button>
            <button onclick="toggleLogin()">Login</button>
            <button onclick="toggleManagerView()">Manager</button>
            <button onclick="viewOrders()">View Orders</button>
        </div>
    </div>
    <div id="login" style="display: none;">
        <h2>Login</h2>
        <form id="loginForm">
            <input type="text" id="username" placeholder="Username" required>
            <input type="password" id="password" placeholder="Password" required>
            <button type="submit">Login</button>
        </form>
    </div>
    <div class="product-list" id="productList"></div>
    <div id="cart">
        <h2>Cart</h2>
        <ul id="cartItems"></ul>
        <p>Total (excl. VAT): <span id="cartTotal">0</span> VND</p>
        <button onclick="proceedToOrder()">Proceed to Order</button>
    </div>
    <div id="order" style="display: none;">
        <h2>Place Order</h2>
        <form id="orderForm">
            <input type="text" id="recipientName" placeholder="Recipient Name" required>
            <input type="email" id="email" placeholder="Email" required>
            <input type="tel" id="phone" placeholder="Phone Number" required>
            <input type="text" id="province" placeholder="Province/City" required>
            <input type="text" id="address" placeholder="Delivery Address" required>
            <label><input type="checkbox" id="rushOrder"> Rush Order (Hanoi only)</label>
            <input type="datetime-local" id="rushDeliveryTime" placeholder="Rush Delivery Time" style="display: none;">
            <input type="text" id="deliveryInstructions" placeholder="Delivery Instructions" style="display: none;">
            <p>Delivery Fee: <span id="deliveryFee">0</span> VND</p>
            <p>Total (incl. VAT): <span id="totalInclVAT">0</span> VND</p>
            <button type="submit">Place Order</button>
        </form>
    </div>
    <div id="manager" style="display: none;">
        <h2>Product Manager</h2>
        <form id="productForm">
            <input type="text" id="productTitle" placeholder="Title" required>
            <select id="productCategory" required>
                <option value="Book">Book</option>
                <option value="CD">CD</option>
                <option value="LPRecord">LP Record</option>
                <option value="DVD">DVD</option>
            </select>
            <input type="number" id="productValue" placeholder="Value (excl. VAT)" required>
            <input type="number" id="productPrice" placeholder="Price (excl. VAT)" required>
            <input type="text" id="productBarcode" placeholder="Barcode" required>
            <input type="text" id="productDescription" placeholder="Description">
            <input type="number" id="productQuantity" placeholder="Quantity" required>
            <input type="date" id="productWarehouseEntryDate" placeholder="Warehouse Entry Date" required>
            <input type="text" id="productDimensions" placeholder="Dimensions">
            <input type="number" id="productWeight" placeholder="Weight (kg)" required>
            <button type="submit">Add Product</button>
        </form>
        <h3>Delete Product</h3>
        <input type="number" id="deleteProductId" placeholder="Product ID">
        <button onclick="deleteProduct()">Delete</button>
    </div>
    <div id="orders" style="display: none;">
        <h2>Orders</h2>
        <ul id="orderList"></ul>
    </div>
</div>

<script>
    let cart = [];
    const VAT = 0.1;
    let token = null;
    let userRole = null;

    // Login
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        try {
            const response = await fetch('http://localhost:8080/api/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });
            const result = await response.json();
            if (response.ok) {
                token = result.token;
                userRole = result.role;
                alert('Login successful.');
                document.getElementById('login').style.display = 'none';
                if (userRole === 'PRODUCT_MANAGER') {
                    document.getElementById('manager').style.display = 'block';
                }
            } else {
                alert(result.message || 'Login failed.');
            }
        } catch (error) {
            console.error('Error logging in:', error);
            alert('Error logging in.');
        }
    });

    // Fetch products
    async function fetchProducts(sort = '') {
        try {
            const response = await fetch(`http://localhost:8080/api/products?sort=${sort}`, {
                headers: token ? { 'Authorization': `Bearer ${token}` } : {}
            });
            const products = await response.json();
            displayProducts(products);
        } catch (error) {
            console.error('Error fetching products:', error);
        }
    }

    // Search products
    async function searchProducts() {
        const query = document.getElementById('searchInput').value;
        const sort = document.getElementById('sortSelect').value;
        try {
            const response = await fetch(`http://localhost:8080/api/products/search?query=${query}&sort=${sort}`, {
                headers: token ? { 'Authorization': `Bearer ${token}` } : {}
            });
            const products = await response.json();
            displayProducts(products);
        } catch (error) {
            console.error('Error searching products:', error);
        }
    }

    // Display products
    function displayProducts(products) {
        const productList = document.getElementById('productList');
        productList.innerHTML = '';
        products.forEach(product => {
            const productCard = document.createElement('div');
            productCard.className = 'product-card';
            productCard.innerHTML = `
          <img src="https://via.placeholder.com/150" alt="${product.title}">
          <h3>${product.title}</h3>
          <p>Price: ${product.price} VND</p>
          <p>Category: ${product.category}</p>
          <button onclick="addToCart(${product.id}, '${product.title}', ${product.price}, ${product.quantity})">Add to Cart</button>
        `;
            productList.appendChild(productCard);
        });
    }

    // Cart functionality
    function addToCart(id, title, price, availableQuantity) {
        const existingItem = cart.find(item => item.id === id);
        if (existingItem) {
            if (existingItem.quantity + 1 > availableQuantity) {
                alert(`Only ${availableQuantity} items available in stock.`);
                return;
            }
            existingItem.quantity += 1;
        } else {
            if (availableQuantity < 1) {
                alert('Product is out of stock.');
                return;
            }
            cart.push({ id, title, price, quantity: 1, availableQuantity });
        }
        updateCart();
    }

    function updateCart() {
        const cartItems = document.getElementById('cartItems');
        const cartTotal = document.getElementById('cartTotal');
        cartItems.innerHTML = '';
        let total = 0;
        cart.forEach(item => {
            const li = document.createElement('li');
            li.textContent = `${item.title} - ${item.quantity} x ${item.price} VND`;
            cartItems.appendChild(li);
            total += item.quantity * item.price;
        });
        cartTotal.textContent = total;
    }

    // Proceed to order
    function proceedToOrder() {
        if (cart.length === 0) {
            alert('Cart is empty.');
            return;
        }
        document.getElementById('cart').style.display = 'none';
        document.getElementById('order').style.display = 'block';
        updateOrderSummary();
    }

    // Update order summary
    function updateOrderSummary() {
        const rushOrder = document.getElementById('rushOrder');
        const rushDeliveryTime = document.getElementById('rushDeliveryTime');
        const deliveryInstructions = document.getElementById('deliveryInstructions');
        const deliveryFeeEl = document.getElementById('deliveryFee');
        const totalInclVATEl = document.getElementById('totalInclVAT');

        rushOrder.addEventListener('change', () => {
            rushDeliveryTime.style.display = rushOrder.checked ? 'block' : 'none';
            deliveryInstructions.style.display = rushOrder.checked ? 'block' : 'none';
            calculateDeliveryFee();
        });

        document.getElementById('address').addEventListener('input', calculateDeliveryFee);
        calculateDeliveryFee();
    }

    // Calculate delivery fee
    function calculateDeliveryFee() {
        const address = document.getElementById('address').value;
        const province = document.getElementById('province').value;
        const rushOrder = document.getElementById('rushOrder').checked;
        let totalWeight = cart.reduce((sum, item) => sum + item.quantity * 0.5, 0); // Assume 0.5kg per item
        let deliveryFee = 0;

        if (rushOrder && province.toLowerCase().includes('hanoi')) {
            deliveryFee = cart.length * 10000; // 10,000 VND per rush item
        } else {
            if (province.toLowerCase().includes('hanoi') || province.toLowerCase().includes('ho chi minh')) {
                deliveryFee = totalWeight <= 3 ? 22000 : 22000 + Math.ceil((totalWeight - 3) / 0.5) * 2500;
            } else {
                deliveryFee = totalWeight <= 0.5 ? 30000 : 30000 + Math.ceil((totalWeight - 0.5) / 0.5) * 2500;
            }
            let totalExclVAT = cart.reduce((sum, item) => sum + item.quantity * item.price, 0);
            if (totalExclVAT > 100000 && !rushOrder) {
                deliveryFee = Math.min(deliveryFee, 25000); // Free shipping up to 25,000 VND
            }
        }

        document.getElementById('deliveryFee').textContent = deliveryFee;
        let totalExclVAT = cart.reduce((sum, item) => sum + item.quantity * item.price, 0);
        let totalInclVAT = totalExclVAT * (1 + VAT) + deliveryFee;
        document.getElementById('totalInclVAT').textContent = totalInclVAT.toFixed(2);
    }

    // Place order
    document.getElementById('orderForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const orderData = {
            recipientName: document.getElementById('recipientName').value,
            email: document.getElementById('email').value,
            phone: document.getElementById('phone').value,
            province: document.getElementById('province').value,
            address: document.getElementById('address').value,
            rushOrder: document.getElementById('rushOrder').checked,
            rushDeliveryTime: document.getElementById('rushDeliveryTime').value,
            deliveryInstructions: document.getElementById('deliveryInstructions').value,
            items: cart,
            deliveryFee: parseFloat(document.getElementById('deliveryFee').textContent),
            totalInclVAT: parseFloat(document.getElementById('totalInclVAT').textContent)
        };

        try {
            const response = await fetch('http://localhost:8080/api/orders', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': token ? `Bearer ${token}` : ''
                },
                body: JSON.stringify(orderData)
            });
            const result = await response.json();
            if (response.ok) {
                window.location.href = result.paymentUrl; // Redirect to VNPay
            } else {
                alert(result.message || 'Error placing order.');
            }
        } catch (error) {
            console.error('Error placing order:', error);
            alert('Error placing order.');
        }
    });

    // Add product
    document.getElementById('productForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (userRole !== 'PRODUCT_MANAGER') {
            alert('Access denied.');
            return;
        }
        const productData = {
            title: document.getElementById('productTitle').value,
            category: document.getElementById('productCategory').value,
            value: parseFloat(document.getElementById('productValue').value),
            price: parseFloat(document.getElementById('productPrice').value),
            barcode: document.getElementById('productBarcode').value,
            description: document.getElementById('productDescription').value,
            quantity: parseInt(document.getElementById('productQuantity').value),
            warehouseEntryDate: document.getElementById('productWarehouseEntryDate').value,
            dimensions: document.getElementById('productDimensions').value,
            weight: parseFloat(document.getElementById('productWeight').value)
        };

        try {
            const response = await fetch('http://localhost:8080/api/products', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(productData)
            });
            if (response.ok) {
                alert('Product added successfully.');
                document.getElementById('productForm').reset();
                fetchProducts();
            } else {
                alert('Error adding product.');
            }
        } catch (error) {
            console.error('Error adding product:', error);
            alert('Error adding product.');
        }
    });

    // Delete product
    async function deleteProduct() {
        if (userRole !== 'PRODUCT_MANAGER') {
            alert('Access denied.');
            return;
        }
        const id = document.getElementById('deleteProductId').value;
        try {
            const response = await fetch(`http://localhost:8080/api/products/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (response.ok) {
                alert('Product deleted successfully.');
                fetchProducts();
            } else {
                alert('Error deleting product.');
            }
        } catch (error) {
            console.error('Error deleting product:', error);
            alert('Error deleting product.');
        }
    }

    // View orders
    async function viewOrders() {
        try {
            const response = await fetch('http://localhost:8080/api/orders', {
                headers: token ? { 'Authorization': `Bearer ${token}` } : {}
            });
            const orders = await response.json();
            displayOrders(orders);
            document.getElementById('orders').style.display = 'block';
            document.getElementById('cart').style.display = 'none';
            document.getElementById('order').style.display = 'none';
            document.getElementById('manager').style.display = 'none';
        } catch (error) {
            console.error('Error fetching orders:', error);
        }
    }

    // Display orders
    function displayOrders(orders) {
        const orderList = document.getElementById('orderList');
        orderList.innerHTML = '';
        orders.forEach(order => {
            const orderCard = document.createElement('div');
            orderCard.className = 'order-card';
            orderCard.innerHTML = `
          <p>Order ID: ${order.id}</p>
          <p>Recipient: ${order.recipientName}</p>
          <p>Total: ${order.totalInclVAT} VND</p>
          <p>Status: ${order.status}</p>
          ${userRole === 'PRODUCT_MANAGER' ? `
            <button onclick="approveOrder(${order.id})">Approve</button>
            <button onclick="rejectOrder(${order.id})">Reject</button>
          ` : ''}
          ${order.status === 'PENDING' && !userRole ? `
            <button onclick="cancelOrder(${order.id})">Cancel</button>
          ` : ''}
        `;
            orderList.appendChild(orderCard);
        });
    }

    // Approve order
    async function approveOrder(id) {
        if (userRole !== 'PRODUCT_MANAGER') {
            alert('Access denied.');
            return;
        }
        try {
            const response = await fetch(`http://localhost:8080/api/orders/${id}/approve`, {
                method: 'PUT',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (response.ok) {
                alert('Order approved.');
                viewOrders();
            } else {
                alert('Error approving order.');
            }
        } catch (error) {
            console.error('Error approving order:', error);
            alert('Error approving order.');
        }
    }

    // Reject order
    async function rejectOrder(id) {
        if (userRole !== 'PRODUCT_MANAGER') {
            alert('Access denied.');
            return;
        }
        try {
            const response = await fetch(`http://localhost:8080/api/orders/${id}/reject`, {
                method: 'PUT',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (response.ok) {
                alert('Order rejected.');
                viewOrders();
            } else {
                alert('Error rejecting order.');
            }
        } catch (error) {
            console.error('Error rejecting order:', error);
            alert('Error rejecting order.');
        }
    }

    // Cancel order
    async function cancelOrder(id) {
        try {
            const response = await fetch(`http://localhost:8080/api/orders/${id}/cancel`, {
                method: 'PUT',
                headers: token ? { 'Authorization': `Bearer ${token}` } : {}
            });
            if (response.ok) {
                alert('Order cancelled.');
                viewOrders();
            } else {
                alert('Error cancelling order.');
            }
        } catch (error) {
            console.error('Error cancelling order:', error);
            alert('Error cancelling order.');
        }
    }

    // Toggle views
    function toggleLogin() {
        document.getElementById('login').style.display = document.getElementById('login').style.display === 'none' ? 'block' : 'none';
    }

    function toggleManagerView() {
        if (userRole !== 'PRODUCT_MANAGER') {
            alert('Access denied.');
            return;
        }
        document.getElementById('manager').style.display = document.getElementById('manager').style.display === 'none' ? 'block' : 'none';
    }

    // Initial fetch
    fetchProducts();
</script>
</body>
</html>